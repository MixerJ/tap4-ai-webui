# Cursor Rules for Tap4 AI WebUI

## 项目概述
这是一个开源的 AI 工具导航网站，使用 Next.js 14 + TypeScript + Supabase 构建，支持多语言和 SEO 优化。

## 核心原则

### 1. 技术栈规范
- **框架**: Next.js 14 with App Router (React Server Components)
- **语言**: TypeScript (严格模式)
- **样式**: Tailwind CSS + Radix UI
- **数据库**: Supabase (PostgreSQL)
- **国际化**: next-intl
- **部署**: Vercel

### 2. 代码质量要求
- 使用 TypeScript 严格模式
- 遵循 ESLint + Prettier 配置
- 组件使用 React Server Components 优先
- 使用自定义 hooks 管理状态
- 遵循组件命名规范

### 2.1 代码格式和缩进规范
- **缩进**: 使用 2 个空格进行缩进，不使用 Tab
- **JSX 缩进**: JSX 元素和属性使用 2 个空格缩进
- **多行字符串**: 模板字符串换行时，内容相对于开始位置缩进 2 个空格
- **JSX 括号位置**: 多行 JSX 的闭合括号应与开始标签对齐
- **文件结尾**: 所有文件必须以换行符结尾
- **尾随空格**: 不允许行尾有多余空格

#### 示例：
```tsx
// ✅ 正确的缩进
<div
  className={`long-class-name ${
    condition ? 'active' : 'inactive'
  }`}
>
  <span>Content</span>
</div>

// ❌ 错误的缩进
<div
    className={`long-class-name ${
        condition ? 'active' : 'inactive'
    }`}
    >
  <span>Content</span>
</div>
```

### 2.2 ESLint 规则遵循
- **react/jsx-indent**: JSX 元素使用 2 个空格缩进
- **react/jsx-indent-props**: JSX 属性使用 2 个空格缩进
- **react/jsx-closing-bracket-location**: 闭合括号位置正确对齐
- **react/jsx-closing-tag-location**: 闭合标签位置正确对齐
- **react/button-has-type**: 所有 button 元素必须有 type 属性
- **jsx-a11y/control-has-associated-label**: 控件必须有关联的标签
- **jsx-a11y/label-has-associated-control**: label 必须与表单控件关联
- **react/jsx-no-target-blank**: 外部链接必须包含 rel="noreferrer"
- **react/no-array-index-key**: 避免使用数组索引作为 key
- **react/no-unescaped-entities**: HTML 实体必须正确转义
- **react/no-unstable-nested-components**: 不在渲染过程中定义组件
- **react/no-nested-ternary**: 避免嵌套三元表达式
- **react/jsx-props-no-spreading**: 谨慎使用属性展开（某些情况下可用 eslint-disable）
- **@typescript-eslint/no-unused-vars**: 移除未使用的变量和导入
- **@typescript-eslint/no-redeclare**: 避免重复声明标识符
- **no-trailing-spaces**: 不允许行尾空格
- **no-console**: 避免使用 console.log/error（生产环境）
- **eol-last**: 文件末尾必须有换行符
- **import/prefer-default-export**: 优先使用默认导出（单一导出时）
- **jsx-quotes**: 使用单引号 JSX 属性
- **arrow-parens**: 箭头函数参数括号规范
- **comma-dangle**: 尾随逗号规范
- **react/jsx-wrap-multilines**: 多行 JSX 表达式必须用括号包围
- **no-confusing-arrow**: 避免箭头函数与条件表达式的歧义
- **@typescript-eslint/indent**: TypeScript 代码缩进规范
- **@next/next/no-img-element**: 使用 Next.js Image 组件而非原生 img 标签
- **react-hooks/exhaustive-deps**: Hook 依赖数组必须完整

### 2.3 常见修复模式

#### React 组件相关
- **按钮类型**: `<button>` → `<button type="button">`
- **可访问性标签**: 添加 `aria-label` 属性到交互元素
- **表单标签关联**: `<label>` 必须有 `htmlFor` 属性，对应控件有 `id`
- **外部链接**: `target="_blank"` → `target="_blank" rel="noreferrer"`
- **图片优化**: `<img>` → `<Image>` (Next.js Image 组件)

#### Key 和列表渲染
- **避免数组索引**: `key={index}` → `key={item.id}` 或 `key={`prefix-${item.name}`}`
- **骨架屏 key**: 使用预定义标识符 `['item1', 'item2', 'item3'].map((id) => <div key={id} />)`
- **图表数据 key**: `key={`chart-${item.label}`}` 而非 `key={index}`

#### TypeScript 和变量
- **未使用变量**: 移除或用 `_` 替代未使用的参数
- **重复声明**: 避免接口和组件同名，如 `SearchFilters` → `SearchFiltersData`
- **类型安全**: 使用严格的 TypeScript 类型定义

#### 样式和格式
- **嵌套三元表达式**: 
  ```tsx
  // ❌ 嵌套三元
  size === 'sm' ? 'size-3' : size === 'lg' ? 'size-5' : 'size-4'
  
  // ✅ 条件类名
  size === 'sm' && 'size-3',
  size === 'md' && 'size-4',
  size === 'lg' && 'size-5'
  ```
- **引号转义**: `"text"` → `&quot;text&quot;` 或使用单引号
- **组件定义**: 将嵌套组件移到渲染函数外部

#### Hook 和依赖
- **useCallback**: 对于在 useEffect 依赖中使用的函数
- **依赖数组**: 包含所有使用的变量和函数
- **错误处理**: 使用 try-catch 但避免 console.error

#### 表单和交互
- **属性展开**: react-hook-form 等必要场景可使用 `eslint-disable-next-line`
- **自闭合标签**: 无子元素的组件使用自闭合语法

### 3. 文件结构规范
```
app/[locale]/           # 国际化路由
  (with-footer)/       # 带页脚的页面组
    (home)/           # 首页相关
    category/         # 分类页面
    explore/          # 探索页面
components/            # 组件库
  ui/                 # 基础UI组件
  home/               # 首页组件
  explore/            # 探索页组件
lib/                  # 工具函数
  utils/              # 通用工具
  constants.ts        # 常量定义
db/                   # 数据库相关
messages/             # 国际化文件
```

### 4. 命名规范
- **组件**: PascalCase (e.g., `Navigation.tsx`)
- **工具函数**: camelCase (e.g., `formatDate.ts`)
- **常量**: SCREAMING_SNAKE_CASE (e.g., `PAGE_SIZE`)
- **文件**: kebab-case for pages, PascalCase for components

### 5. 开发工作流
1. 使用 pnpm 作为包管理器
2. 遵循 git 提交规范
3. 所有代码需要通过 ESLint 和 Prettier 检查
4. 新功能需要添加相应的测试
5. 数据库变更需要更新 SQL 文件

### 6. 性能优化
- 使用 React Server Components 减少客户端 bundle
- 图片优化使用 Next.js Image 组件
- 实现适当的数据缓存策略
- SEO 优化：动态 sitemap、元数据等

### 7. 安全考虑
- 环境变量正确配置
- API 密钥安全存储
- 输入验证和 XSS 防护
- CORS 配置正确

### 8. 可访问性
- 遵循 WCAG 2.1 标准
- 支持键盘导航
- 屏幕阅读器友好
- 颜色对比度符合标准

### 9. 多语言支持
- 使用 next-intl 进行国际化
- 所有用户可见文本都需要国际化
- 支持 RTL 语言布局
- 日期和数字格式本地化

### 10. 数据管理
- 使用 Supabase 作为主要数据源
- 实现适当的错误处理
- 数据验证使用 Zod
- API 路由遵循 RESTful 规范

## 开发环境设置
1. Node.js >= 20.0.0
2. pnpm >= 8.0.0
3. 配置环境变量 (.env.local)
4. 安装依赖：`pnpm install`
5. 启动开发服务器：`pnpm dev`

## 部署要求
- Vercel 平台部署
- 环境变量正确配置
- 数据库连接正常
- 构建通过所有检查

## 编码实践指南

### 组件开发规范
```tsx
// ✅ 推荐的组件结构
'use client'; // 仅在需要客户端功能时使用

import { useState, useEffect } from 'react';
import { Icon } from 'lucide-react';
import { useTranslations } from 'next-intl';

interface ComponentProps {
  title: string;
  isActive?: boolean;
}

export default function MyComponent({ title, isActive = false }: ComponentProps) {
  const t = useTranslations('Common');
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  if (!mounted) return null;

  return (
    <div className="component-container">
      <h2 className="text-lg font-semibold">{title}</h2>
      <button 
        type="button"
        aria-label={t('clickAction')}
        className="btn-primary"
      >
        <Icon className="size-4" />
        {t('action')}
      </button>
    </div>
  );
}
```

### 样式类命名规范
- 使用 Tailwind CSS 工具类
- 复杂样式组合使用 `className` 字符串模板
- 条件样式使用三元运算符或 `clsx` 库
- 响应式设计优先使用 `sm:`、`md:`、`lg:`、`xl:` 前缀

### 国际化文本处理
- 所有用户可见文本必须使用 `useTranslations` hook
- 避免硬编码文本内容
- 动态文本内容使用插值语法

## 第三阶段优化中遇到的典型问题和解决方案

### ESLint 错误修复实例

#### 1. 缩进问题 (react/jsx-indent)
**问题**: JSX 元素缩进不一致，混用空格和制表符
**解决**: 统一使用 2 个空格缩进，确保所有 JSX 元素对齐

#### 2. 数组索引作为 Key (react/no-array-index-key)
**问题**: `{items.map((item, index) => <div key={index} />)}`
**解决**: 
```tsx
// ✅ 使用有意义的标识符
{items.map((item) => <div key={`item-${item.id}`} />)}

// ✅ 骨架屏使用预定义标识符
{['overview', 'stats', 'charts'].map((id) => <div key={`skeleton-${id}`} />)}
```

#### 3. 嵌套组件定义 (react/no-unstable-nested-components)
**问题**: 在渲染函数内定义组件
**解决**: 将组件移到主组件外部定义

#### 4. TypeScript 重复声明 (@typescript-eslint/no-redeclare)
**问题**: 接口名与组件名冲突
**解决**: 重命名接口 `SearchFilters` → `SearchFiltersData`

#### 5. 未使用变量 (@typescript-eslint/no-unused-vars)
**问题**: `map((item, index) => {})` 中 index 未使用
**解决**: 
```tsx
// ✅ 移除未使用参数
map((item) => {})

// ✅ 或使用下划线表示忽略
map((item, _) => {})
```

#### 6. 嵌套三元表达式 (no-nested-ternary)
**问题**: `size === 'sm' ? 'size-3' : size === 'lg' ? 'size-5' : 'size-4'`
**解决**:
```tsx
// ✅ 使用条件类名
className={cn(
  size === 'sm' && 'size-3',
  size === 'md' && 'size-4',
  size === 'lg' && 'size-5'
)}
```

#### 7. 表单标签关联 (jsx-a11y/label-has-associated-control)
**问题**: `<label>` 没有关联的表单控件
**解决**: 
```tsx
// ✅ 添加 htmlFor 和对应的 id
<label htmlFor="search-input">搜索</label>
<input id="search-input" type="text" />

// ✅ 或改为语义正确的元素
<h4>分享到</h4> // 而非 <label>分享到</label>
```

#### 8. 属性展开限制 (react/jsx-props-no-spreading)
**问题**: 禁止使用属性展开
**解决**: 
```tsx
// ✅ 必要场景使用 eslint-disable
// eslint-disable-next-line react/jsx-props-no-spreading
<Form {...form}>
```

#### 9. Console 语句 (no-console)
**问题**: 生产代码中包含 console.log/error
**解决**: 移除或使用适当的错误处理

#### 10. Hook 依赖问题 (react-hooks/exhaustive-deps)
**问题**: useEffect 缺少依赖项
**解决**: 
```tsx
// ✅ 使用 useCallback 包装函数
const loadData = useCallback(() => {
  // 逻辑
}, [dependency]);

useEffect(() => {
  loadData();
}, [loadData]);
```

#### 11. JSX 多行括号 (react/jsx-wrap-multilines)
**问题**: 多行 JSX 表达式没有用括号包围
**解决**: 
```tsx
// ❌ 缺少括号
<Suspense
  fallback={
    <div className='loading'>
      <span>Loading...</span>
    </div>
  }
>

// ✅ 正确的括号包围
<Suspense
  fallback={(
    <div className='loading'>
      <span>Loading...</span>
    </div>
  )}
>
```

#### 12. 图片优化 (@next/next/no-img-element)
**问题**: 使用原生 `<img>` 标签而非 Next.js Image 组件
**解决**:
```tsx
// ❌ 原生 img 标签
<img src='/images/logo.png' alt='Logo' className='w-24' />

// ✅ Next.js Image 组件
import Image from 'next/image';
<Image src='/images/logo.png' alt='Logo' width={96} height={96} className='w-24' />
```

### Vercel 构建常见问题

#### 构建失败的典型原因
1. **ESLint 错误**: 任何 ESLint 错误都会导致构建失败
2. **TypeScript 类型错误**: 类型不匹配或缺少类型定义
3. **导入路径错误**: 文件路径不正确或文件不存在
4. **环境变量缺失**: 构建时需要的环境变量未配置
5. **依赖问题**: package.json 中的依赖版本冲突

#### 构建前检查清单
- [ ] 运行 `npm run lint` 确保无 ESLint 错误
- [ ] 运行 `npm run build` 本地构建测试
- [ ] 检查所有导入路径是否正确
- [ ] 确认环境变量已正确配置
- [ ] 验证 TypeScript 类型无错误

### Vercel 构建错误修复实例

基于实际构建失败的经验，以下是常见错误和修复方案：

#### 构建日志分析
```
Failed to compile.
./app/[locale]/(with-footer)/favorites/page.tsx
45:11  Error: Missing parentheses around multilines JSX  react/jsx-wrap-multilines
```

**修复步骤**:
1. 定位具体文件和行号
2. 理解错误类型（ESLint 规则违反）
3. 应用对应的修复模式
4. 验证修复效果

#### 批量修复策略
当遇到大量 ESLint 错误时：
1. **按文件分组**: 先修复一个文件的所有错误
2. **按规则分组**: 批量修复同类型错误
3. **优先级排序**: 先修复错误（Error），再修复警告（Warning）
4. **工具辅助**: 使用 `eslint --fix` 自动修复简单问题

### 建议的开发流程

1. **编写组件时立即检查**: 使用 ESLint 实时检查
2. **提交前验证**: 运行 `npm run lint` 和 `npm run build` 确保无错误
3. **使用工具**: 配置编辑器自动修复简单问题
4. **团队规范**: 统一使用相同的 ESLint 配置
5. **构建测试**: 在推送到远程仓库前进行本地构建测试
6. **错误日志**: 仔细阅读构建错误日志，定位具体问题
7. **渐进修复**: 分批修复错误，避免一次性改动过多

## 代码审查标准
- 功能完整性
- 代码质量和规范
- 性能影响
- 安全性考虑
- 文档完整性
- ESLint 规则完全通过
- 无构建警告和错误
